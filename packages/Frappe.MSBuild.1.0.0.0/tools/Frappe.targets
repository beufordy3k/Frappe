<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="CreateBundles" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Frappe.Tasks.GetFilesFromBundle" AssemblyFile="Frappe.MSBuild.dll" />
  <UsingTask TaskName="Frappe.Tasks.BundleFiles" AssemblyFile="Frappe.MSBuild.dll" />
  <UsingTask TaskName="AjaxMin" AssemblyFile="AjaxMin\AjaxMinTask.dll" />
  <Target Name="CompileBundles" AfterTargets="AfterBuild">
    <ItemGroup>
      <SourceBundleFiles Include="$(MSBuildProjectDirectory)\**\*.bundle" />
      <BundleFiles Include="%(SourceBundleFiles.Identity)">
        <OutputFile>$([System.Text.RegularExpressions.Regex]::Replace(%(Identity),'(.+?)\.bundle$','$1', System.Text.RegularExpressions.RegexOptions.IgnoreCase))</OutputFile>
      </BundleFiles>
    </ItemGroup>
    <!--<Message Text="Creating &quot;%(BundleFiles.OutputFile)&quot; from bundle &quot;%(BundleFiles.Identity)&quot;." />-->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="CompileBundle" Properties="BundleFile=%(BundleFiles.Identity);OutputFile=%(BundleFiles.OutputFile)" />
  </Target>
  <Target Name="TransformBundle" Inputs="@(ImportFiles);@(CssFiles);@(JavaScriptFiles);$(BundleFile)" Outputs="$(OutputFile)" DependsOnTargets="ReadBundle;TransformCssIncludeFiles;TransformJavaScriptIncludeFiles">
    <!--<Message Text="CssFiles: %(CssFiles.Identity)" />
    <Message Text="OutputFile: %(CssFiles.OutputFile)" />
    <Message Text="JavaScriptFiles: %(JavaScriptFiles.Identity)" />
    <Message Text="OutputFile: %(JavaScriptFiles.OutputFile)" />
    <Message Text="BundleFile: $(BundleFile)" />
    <Message Text="OutputFile: $(OutputFile)" />-->
    <ItemGroup>
      <BundleContentFiles Include="%(CssFiles.OutputFile)" />
      <BundleContentFiles Include="%(JavaScriptFiles.OutputFile)" />
    </ItemGroup>
  </Target>
  <Target Name="CompileBundle" Inputs="@(ImportFiles);@(BundleContentFiles);$(BundleFile)" Outputs="$(OutputFile)" DependsOnTargets="TransformBundle">
    <Frappe.Tasks.BundleFiles File="$(OutputFile)" Overwrite="true" Inputs="@(BundleContentFiles)" />
  </Target>
  <Target Name="ReadBundle">
    <Message Text="Loading bundle includes from &quot;$(BundleFile)&quot;." />
    <Frappe.Tasks.GetFilesFromBundle BundleFile="$(BundleFile)">
      <Output TaskParameter="Files" ItemName="IncludeFiles" />
      <Output TaskParameter="ImportFiles" ItemName="ImportFiles" />
    </Frappe.Tasks.GetFilesFromBundle>
    <ItemGroup>
      <CssFiles Condition="$([System.Text.RegularExpressions.Regex]::IsMatch(%(IncludeFiles.Identity),'.+\.css$', System.Text.RegularExpressions.RegexOptions.IgnoreCase))" Include="%(IncludeFiles.Identity)">
        <FileType>css</FileType>
        <CssInputFile>%(Identity)</CssInputFile>
        <OutputFile>$([System.Text.RegularExpressions.Regex]::Replace(%(Identity),'(.+?)(?:\.min)?\.(css|less)$','$1.min.css', System.Text.RegularExpressions.RegexOptions.IgnoreCase))</OutputFile>
      </CssFiles>
      <CssFiles Condition="$([System.Text.RegularExpressions.Regex]::IsMatch(%(IncludeFiles.Identity),'.+\.less$', System.Text.RegularExpressions.RegexOptions.IgnoreCase))" Include="%(IncludeFiles.Identity)">
        <FileType>less</FileType>
        <CssInputFile>%(Identity).css</CssInputFile>
        <OutputFile>$([System.Text.RegularExpressions.Regex]::Replace(%(Identity),'(.+?)(?:\.less)$','$1.less.min.css', System.Text.RegularExpressions.RegexOptions.IgnoreCase))</OutputFile>
      </CssFiles>
      <JavaScriptFiles Condition="$([System.Text.RegularExpressions.Regex]::IsMatch(%(IncludeFiles.Identity),'.+\.js$', System.Text.RegularExpressions.RegexOptions.IgnoreCase))" Include="%(IncludeFiles.Identity)">
        <OutputFile>$([System.Text.RegularExpressions.Regex]::Replace(%(Identity),'(.+?)(?:\.min)?\.js$','$1.min.js', System.Text.RegularExpressions.RegexOptions.IgnoreCase))</OutputFile>
      </JavaScriptFiles>
    </ItemGroup>
    <!--<Message Text="CssFiles: %(CssFiles.Identity)" />
    <Message Text="OutputFile: %(CssFiles.OutputFile)" />
    <Message Text="JavaScriptFiles: %(JavaScriptFiles.Identity)" />
    <Message Text="ImportFiles: %(ImportFiles.Identity)" />
    <Message Text="OutputFile: %(JavaScriptFiles.OutputFile)" />-->
  </Target>
  <Target Name="TransformCssIncludeFiles" Inputs="%(CssFiles.Identity)" Outputs="%(CssFiles.OutputFile)">
    <!--<Message Text="Minify css!" />
    <Message Text="CssFiles: %(CssFiles.Identity)" />
    <Message Text="OutputFile: %(CssFiles.OutputFile)" />-->
    <Exec Condition="'%(CssFiles.FileType)' == 'less'" Command="dotLess\dotless.compiler.exe &quot;%(CssFiles.Identity)&quot; &quot;%(CssFiles.CssInputFile)&quot;" />
    <AjaxMin CssSourceFiles="%(CssFiles.CssInputFile)" CssSourceExtensionPattern="\.css$" CssTargetExtension=".min.css" />
  </Target>
  <Target Name="TransformJavaScriptIncludeFiles" Inputs="%(JavaScriptFiles.Identity)" Outputs="%(JavaScriptFiles.OutputFile)">
    <!--<Message Text="Minify js!" />
    <Message Text="JavaScriptFiles: %(JavaScriptFiles.Identity)" />
    <Message Text="OutputFile: %(JavaScriptFiles.OutputFile)" />-->
    <AjaxMin JsSourceFiles="%(JavaScriptFiles.Identity)" JsSourceExtensionPattern="\.css$" JsTargetExtension=".min.css" />
  </Target>
</Project>